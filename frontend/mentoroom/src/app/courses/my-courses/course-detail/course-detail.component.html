<div class="container" [@side-panel]>
  <div class="course-header">
    <div class="first-line">
      <p-button
        *ngIf="userRole === 'Lecturer'"
        (click)="OnEditCourseShow()"
        [icon]="'pi pi-cog'"
        class="edit-course-btn"
      ></p-button>
      <h1>{{ course.name }}</h1>

      <div class="wrapper">
        <p-selectButton
          *ngIf="userRole === 'Lecturer'"
          [options]="modeOptions"
          [(ngModel)]="mode"
          optionLabel="icon"
        >
          <ng-template let-item pTemplate>
            <i [class]="item.icon"></i>
          </ng-template>
        </p-selectButton>

        <p-button
          *ngIf="userRole === 'Lecturer'"
          (click)="OnNewAssignment()"
          label="New assignnment"
          iconPos="right"
          icon="pi pi-plus"
        ></p-button>
        <p-button
          *ngIf="userRole === 'Lecturer' && hasRequiredFiles()"
          (click)="downloadStudentsFilesByCourse()"
          >Download <i class="pi pi-download download-btn-icon"></i
        ></p-button>
      </div>
    </div>
    <p>{{ course.description }}</p>
  </div>

  <div *ngIf="mode.type === 'DefaultMode'">
    <p-accordion [style]="{ width: '45vw' }" *ngIf="!isLoading">
      <p-divider [style]="{ margin: '1px' }"></p-divider>
      <p-accordionTab
        [disabled]="userRole !== 'Lecturer' ? !assignmentEl.isActive : false"
        *ngFor="let assignmentEl of assignments"
      >
        <ng-template pTemplate="header">
          <div class="assignment-header">
            <p>{{ assignmentEl.name }}</p>
            <p>
              Deadline:
              {{ assignmentEl.deadLineDate | date : "yyyy-MM-dd HH:mm" }}
            </p>
            <p *ngIf="userRole === 'Lecturer'" style="margin-right: 10px">
              <i
                *ngIf="assignmentEl.isActive"
                class="pi pi-check-circle"
                style="color: #00bfa6"
              ></i>
              <i
                *ngIf="!assignmentEl.isActive"
                class="pi pi-times-circle"
                style="color: #f87171"
              ></i>
            </p>
          </div>
        </ng-template>

        <div
          class="content"
          *ngIf="assignmentEl.isActive || userRole === 'Lecturer'"
        >
          <div class="description-container">
            <p class="description">{{ assignmentEl.description }}</p>
            <p-button
              *ngIf="
                userRole === 'Lecturer' && assignmentEl.requiredFiles.length > 0
              "
              (click)="downloadStudentsFilesByAssignment(assignmentEl)"
              class="download-assignment-btn"
              >Download <i class="pi pi-download download-btn-icon"></i
            ></p-button>

            <!-- Resourse -->
            <div class="assignment-buttons">
              <p-button
                (click)="OnEditAssignment(assignmentEl)"
                *ngIf="userRole === 'Lecturer'"
                class="edit-assignment-button"
                icon="pi pi-file-edit"
                label="Edit Assignment"
              ></p-button>
            </div>
            <div class="resource-btns">
              <p-button
                (click)="OnEditResources(assignmentEl)"
                icon="pi pi-file-edit"
                *ngIf="userRole === 'Lecturer'"
              />
              <div
                class="resource"
                *ngIf="
                  assignmentEl.assignmentFiles &&
                  assignmentEl.assignmentFiles.length > 0
                "
              >
                <div class="resource-button">
                  <button
                    [style]="{ width: '130px', }"
                    pButton
                    type="button"
                    (click)="menu.toggle($event)"
                    icon="pi pi-folder-open"
                    label="Resource"
                  ></button>
                  <p-menu
                    #menu
                    [model]="assignmentEl.menuItems"
                    [popup]="true"
                  ></p-menu>
                </div>
              </div>
            </div>

            <!-- Required files -->

            <p class="required-files-text">Required files</p>
            <div
              *ngIf="userRole === 'Lecturer'"
              class="add-new-required-file-btn"
            >
              <p-button
                (click)="OnEditRequiredFilesShow(assignmentEl)"
                icon="pi pi-file-edit
            "
                [rounded]="true"
              ></p-button>
            </div>

            <div
              class="required-files-sector"
              [ngClass]="{
                'student-required-files-sector': userRole === 'Student',
                'other-class': userRole !== 'Student'
              }"
            >
              <div
                class="required-files-container"
                *ngIf="assignmentEl.requiredFiles.length > 0"
              >
                <div *ngFor="let requiredFile of assignmentEl.requiredFiles">
                  <div *ngIf="requiredFile.isSended">
                    <i
                      class="pi pi-check-circle sended-icon"
                      style="color: green"
                    ></i>
                    <div class="sended-required-file-tile">
                      <p class="sended-file-text">Sended File</p>
                      <p>File name: {{ requiredFile.fileNameSuffix }}</p>
                      <p>Max size: {{ requiredFile.maxSizeInKb }} Kb</p>
                      <p>Extension: {{ requiredFile.extension }}</p>
                      <div class="sended-file-btn-container">
                        <p-button
                          class="sended-file-btn"
                          (click)="downloadSendedFile(requiredFile)"
                          >Download
                          <i class="pi pi-download download-btn-icon"></i
                        ></p-button>
                        <p-button
                          class="sended-file-btn"
                          (click)="deleteSendedFile(requiredFile)"
                          >Delete <i class="pi pi-trash download-btn-icon"></i
                        ></p-button>
                      </div>
                    </div>
                  </div>
                  <button
                    (click)="
                      deleteRequiredFile(assignmentEl.id, requiredFile.id)
                    "
                    class="delete-required-file-btn"
                    pButton
                    type="button"
                    icon="pi pi-times"
                    *ngIf="userRole === 'Lecturer'"
                  ></button>
                  <div
                    *ngIf="
                      (userRole === 'Student' && !requiredFile.isSended) ||
                      userRole === 'Lecturer'
                    "
                  >
                    <i
                      *ngIf="userRole === 'Student'"
                      class="pi pi-times-circle not-sended-icon"
                      style="color: red"
                    ></i>
                    <div
                      [ngClass]="{
                        'student-required-files': userRole === 'Student',
                        'other-class': userRole !== 'Student'
                      }"
                      class="required-file-tile"
                    >
                      <p>File name: {{ requiredFile.fileNameSuffix }}</p>
                      <p>Max size: {{ requiredFile.maxSizeInKb }} Kb</p>
                      <p>Allowed extension: {{ requiredFile.extension }}</p>
                      <p-fileUpload
                        *ngIf="userRole === 'Student'"
                        [style]="{
                          width: '70%',
                          border: '1px dotted #e2e8f0;'
                        }"
                        (uploadHandler)="
                          onStudentFileHandled($event, requiredFile.id)
                        "
                        [customUpload]="true"
                        [multiple]="false"
                        [accept]="'.' + requiredFile?.extension"
                        [maxFileSize]="requiredFile?.maxSizeInKb * 1024"
                        fileLimit="1"
                      >
                        <ng-template pTemplate="content">
                          <div>
                            <ul *ngIf="uploadedResourceFile">
                              <li>
                                {{ uploadedResourceFile.name }} -
                                {{ uploadedResourceFile.size }} bytes
                              </li>
                            </ul>
                          </div>
                        </ng-template>
                      </p-fileUpload>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </p-accordionTab>
    </p-accordion>
  </div>

  <div *ngIf="mode.type === 'StudentListMode'">
    <app-student-list></app-student-list>
  </div>

  <p-dialog
    *ngIf="editedAssignment"
    header="Edit Assignment"
    [draggable]="false"
    [modal]="true"
    [(visible)]="visibleEditAssignment"
    [style]="{ width: '30rem' }"
    (onHide)="OnEditAssignmentHide()"
  >
    <div class="edit-assignment-container">
      <div class="edit-assignment-row-1">
        <p-calendar
          appendTo="body"
          [showTime]="true"
          [hourFormat]="24"
          [(ngModel)]="editedAssignment.deadLineDate"
          [iconDisplay]="'input'"
          [showIcon]="true"
          inputId="icondisplay"
          [style]="{ width: '20rem' }"
        />

        <div class="checkbox-div">
          <p-checkbox
            [(ngModel)]="editedAssignment.isActive"
            [binary]="true"
            label="Is Active"
            name="isActive"
          />
        </div>
      </div>

      <p-floatLabel>
        <textarea
          rows="5"
          type="text"
          id="description"
          pInputText
          [(ngModel)]="editedAssignment.description"
          pInputTextarea
          [style]="{ width: '27rem' }"
        ></textarea>
        <label for="description">Description</label>
      </p-floatLabel>

      <div class="edit-assignment-buttons-container">
        <div class="save-assignment-button">
          <p-button
            label="Delete"
            severity="danger"
            icon="pi pi-trash"
            iconPos="right"
            (click)="deleteAssignment()"
            [style]="{ width: '12.5rem' }"
          />
        </div>

        <div class="save-assignment-button">
          <p-button
            label="Save"
            icon="pi pi-save"
            iconPos="right"
            (click)="editAssignment()"
            [style]="{ width: '12.5rem' }"
          />
        </div>
      </div>
    </div>
  </p-dialog>

  <p-dialog
    *ngIf="editedAssignment"
    header="Edit Resources"
    [modal]="true"
    [draggable]="false"
    [(visible)]="visibleEditResources"
    [style]="{ width: '30rem' }"
    (onHide)="OnEditResourcesHide()"
    class="edit-resources"
  >
    <div
      *ngFor="let file of editedAssignment.assignmentFiles"
      class="attachment"
    >
      <div class="resources-row" *ngIf="file">
        <p-floatLabel>
          <input
            [disabled]="true"
            type="text"
            id="name"
            pInputText
            [(ngModel)]="file?.name.split('.')[0]"
            [style]="{ width: '7rem' }"
          />
          <label for="name">Name</label>
        </p-floatLabel>
        <p-floatLabel>
          <input
            [disabled]="true"
            type="text"
            id="extension"
            pInputText
            [(ngModel)]="file?.name.split('.')[1]"
            [style]="{ width: '5rem' }"
          />
          <label for="extension">Extension</label>
        </p-floatLabel>

        <div class="buttons-container">
          <p-button
            size="small"
            [rounded]="true"
            (click)="downloadResource(file)"
            icon="pi pi-download"
          />
          <p-button
            size="small"
            [rounded]="true"
            (click)="deleteResource(file.id)"
            icon="pi pi-times"
          />
        </div>
      </div>
    </div>
    <div class="file-upload-container">
      <p-fileUpload
        (uploadHandler)="onResourceHandled($event)"
        [customUpload]="true"
        [multiple]="false"
      >
        <ng-template pTemplate="content">
          <ul *ngIf="uploadedResourceFile">
            <li>
              {{ uploadedResourceFile.name }} -
              {{ uploadedResourceFile.size }} bytes
            </li>
          </ul>
        </ng-template>
      </p-fileUpload>
    </div>
  </p-dialog>

  <p-dialog
    header="Add New Assignment"
    [draggable]="false"
    [modal]="true"
    [(visible)]="visibleAddAssignment"
    [style]="{ width: '50rem' }"
  >
    <app-add-assignment
      (addedAssignment)="addAssignment($event)"
    ></app-add-assignment>
  </p-dialog>

  <p-dialog
    *ngIf="visibleRequiredFiles"
    header="Edit Required Files"
    [draggable]="false"
    [modal]="true"
    [(visible)]="visibleRequiredFiles"
    [style]="{ width: '50rem' }"
    (onHide)="OnEditRequiredFilesHide()"
  >
    <app-add-required-files
      [assignnmentId]="editedAssignment.id"
      [files]="editedAssignment.requiredFiles"
    ></app-add-required-files>
  </p-dialog>

  <p-dialog
    header="Edit Course"
    [draggable]="false"
    [modal]="true"
    [(visible)]="visibleEditCourse"
    [style]="{ width: '35rem' }"
  >
    <app-edit-course
      (courseUpdated)="handleCourseUpdated($event)"
      [course]="course"
    ></app-edit-course>
  </p-dialog>

  <div *ngIf="isLoading" class="spinner">
    <app-loading-spinner></app-loading-spinner>
  </div>
</div>
